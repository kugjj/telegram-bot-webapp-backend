<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π WebApp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      min-height: 100vh;
      padding: 20px 10px;
    }
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      color: white;
    }
    .action, .message {
      padding: 10px;
      margin: 6px 0;
      background: rgba(0, 212, 255, 0.1);
      border-radius: 10px;
      font-size: 14px;
    }
    .message-user {
      border-left: 4px solid #00d4ff;
    }
    .message-bot {
      border-left: 4px solid #ff6b6b;
    }
    input, button {
      margin-top: 10px;
    }
    .game-box {
      text-align: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
    }
    .loader {
      color: #aaa;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4">üéÆ –ü—Ä–∏–≤–µ—Ç, <span id="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>!</h1>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
      <div class="col-6 stat-box">
        <div class="stat-value" id="user-count">‚Äî</div>
        <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
      </div>
      <div class="col-6 stat-box">
        <div class="stat-value" id="action-count">‚Äî</div>
        <div>–î–µ–π—Å—Ç–≤–∏–π</div>
      </div>
    </div>

    <!-- –ò–≥—Ä–∞ -->
    <div class="card p-3 mb-4">
      <h5><i class="bi bi-controller"></i> –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ</h5>
      <div class="game-box">
        <p>–Ø –∑–∞–≥–∞–¥–∞–ª —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10</p>
        <input type="number" id="guess" min="1" max="10" placeholder="–¢–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç">
        <button class="btn btn-sm btn-success" onclick="makeGuess()">–£–≥–∞–¥–∞—Ç—å</button>
        <div id="game-result" class="mt-2"></div>
      </div>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="card p-3 mb-4">
      <h5><i class="bi bi-chat-left-text"></i> –ù–∞–ø–∏—à–∏ –±–æ—Ç—É</h5>
      <input type="text" id="message-input" class="form-control" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å...">
      <button class="btn btn-primary mt-2" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <div id="messages" class="mt-3">
        <div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
      </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="card p-3">
      <h5><i class="bi bi-clock-history"></i> –¢–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è</h5>
      <div id="actions">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const user = tg.initDataUnsafe.user || {};
    document.getElementById('user').textContent = user.username || user.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";

    const API_URL = "https://web-production-7ec07.up.railway.app";

    // --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---
    fetch(`${API_URL}/api/stats`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('user-count').textContent = data.users || 0;
        document.getElementById('action-count').textContent = data.actions || 0;
      });

    // --- –î–µ–π—Å—Ç–≤–∏—è ---
    if (user.id) {
      fetch(`${API_URL}/api/user/actions?user_id=${user.id}`)
        .then(r => r.json())
        .then(data => {
          const container = document.getElementById('actions');
          container.innerHTML = '';
          if (!data || data.length === 0) {
            container.textContent = '–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π.';
            return;
          }
          data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'action';
            const time = new Date(item.time).toLocaleString('ru-RU');
            div.textContent = `[${time}] ${item.action}`;
            container.appendChild(div);
          });
        });
    }

    // --- –°–æ–æ–±—â–µ–Ω–∏—è ---
    function loadMessages() {
      if (user.id) {
        fetch(`${API_URL}/api/user/messages?user_id=${user.id}`)
          .then(r => r.json())
          .then(data => {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            if (!data || data.length === 0) {
              container.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.';
              return;
            }
            data.forEach(msg => {
              const div = document.createElement('div');
              div.className = 'message message-user';
              const time = new Date(msg.time).toLocaleTimeString('ru-RU');
              div.textContent = `[${time}] ${msg.text}`;
              container.appendChild(div);
            });
          });
      }
    }

    function sendMessage() {
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      if (!text || !user.id) return;

      fetch(`${API_URL}/api/user/message`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: user.id, text: text })
      })
      .then(r => r.json())
      .then(() => {
        input.value = '';
        loadMessages();
      });
    }

    // --- –ò–≥—Ä–∞ ---
    function makeGuess() {
      const guess = document.getElementById('guess').value;
      if (!guess) return;
      const result = document.getElementById('game-result');
      const secret = Math.floor(Math.random() * 10) + 1;
      if (guess == secret) {
        result.innerHTML = `<span style="color:green">üéâ –£–≥–∞–¥–∞–ª! –Ø –∑–∞–≥–∞–¥–∞–ª ${secret}</span>`;
      } else {
        result.innerHTML = `<span style="color:red">‚ùå –ù–µ —É–≥–∞–¥–∞–ª! –Ø –∑–∞–≥–∞–¥–∞–ª ${secret}</span>`;
      }
      setTimeout(() => result.innerHTML = '', 2000);
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadMessages();
  </script>
</body>
</html>

