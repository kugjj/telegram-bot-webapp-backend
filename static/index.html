<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>–ú–æ–π –ë–æ—Ç</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      min-height: 100vh;
      padding: 20px 10px;
      margin: 0;
    }
    .header {
      text-align: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }
    .header h1 {
      margin: 0;
      font-size: 1.5em;
      text-shadow: 0 0 5px rgba(0, 212, 255, 0.5);
    }
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(26, 26, 46, 0.9);
      backdrop-filter: blur(10px);
      display: flex;
      padding: 10px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }
    .tab {
      flex: 1;
      text-align: center;
      color: #aaa;
      font-size: 0.9em;
    }
    .tab i {
      font-size: 1.3em;
      display: block;
    }
    .tab.active {
      color: #00d4ff;
      font-weight: bold;
    }
    .tab.active i {
      color: #00d4ff;
    }
    .content {
      margin-bottom: 70px; /* —á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª–æ –º–µ–Ω—é */
    }
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      color: white;
      padding: 16px;
      margin-bottom: 16px;
    }
    .action, .message {
      padding: 10px;
      margin: 6px 0;
      background: rgba(0, 212, 255, 0.1);
      border-radius: 10px;
      font-size: 14px;
    }
    .message-user {
      border-left: 4px solid #00d4ff;
    }
    input, button {
      margin-top: 10px;
    }
    .loader {
      color: #aaa;
      font-style: italic;
      text-align: center;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="header">
    <h1>üëã <span id="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span></h1>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <div class="content">
    <!-- –í–∫–ª–∞–¥–∫–∞: –î–µ–π—Å—Ç–≤–∏—è -->
    <div id="tab-actions">
      <div class="card">
        <h5><i class="bi bi-clock-history"></i> –¢–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è</h5>
        <div id="actions">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞: –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="tab-messages" class="hidden">
      <div class="card">
        <h5><i class="bi bi-chat-left-text"></i> –ù–∞–ø–∏—à–∏ –±–æ—Ç—É</h5>
        <input type="text" id="message-input" class="form-control" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å...">
        <button class="btn btn-primary mt-2" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <div id="messages" class="mt-3">
          <div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
        </div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞: –ò–≥—Ä–∞ -->
    <div id="tab-game" class="hidden">
      <div class="card">
        <h5><i class="bi bi-controller"></i> –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ</h5>
        <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px;">
          <p>–Ø –∑–∞–≥–∞–¥–∞–ª —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10</p>
          <input type="number" id="guess" min="1" max="10" placeholder="–¢–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç" class="form-control" style="width: 60%; margin: 10px auto;">
          <button class="btn btn-success" onclick="makeGuess()">–£–≥–∞–¥–∞—Ç—å</button>
          <div id="game-result" class="mt-2"></div>
        </div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞: –ü—Ä–æ—Ñ–∏–ª—å -->
    <div id="tab-profile" class="hidden">
      <div class="card">
        <h5><i class="bi bi-person"></i> –¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h5>
        <div id="profile-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div class="card">
        <h5><i class="bi bi-graph-up"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
        <div id="stats">
          <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</strong> <span id="user-count">‚Äî</span><br>
          <strong>–î–µ–π—Å—Ç–≤–∏–π:</strong> <span id="action-count">‚Äî</span>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–µ–Ω—é (–≤–∫–ª–∞–¥–∫–∏) -->
  <div class="tab-bar">
    <div class="tab active" onclick="switchTab('actions')">
      <i class="bi bi-clock-history"></i>
      <span>–î–µ–π—Å—Ç–≤–∏—è</span>
    </div>
    <div class="tab" onclick="switchTab('messages')">
      <i class="bi bi-chat-left-text"></i>
      <span>–°–æ–æ–±—â–µ–Ω–∏—è</span>
    </div>
    <div class="tab" onclick="switchTab('game')">
      <i class="bi bi-controller"></i>
      <span>–ò–≥—Ä–∞</span>
    </div>
    <div class="tab" onclick="switchTab('profile')">
      <i class="bi bi-person"></i>
      <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const user = tg.initDataUnsafe.user || {};
    document.getElementById('user').textContent = user.username || user.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";

    const API_URL = "https://web-production-7ec07.up.railway.app";

    // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ---
    function switchTab(tabName) {
      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ
      document.getElementById('tab-actions').classList.add('hidden');
      document.getElementById('tab-messages').classList.add('hidden');
      document.getElementById('tab-game').classList.add('hidden');
      document.getElementById('tab-profile').classList.add('hidden');

      // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
      document.getElementById('tab-' + tabName).classList.remove('hidden');
      // –î–µ–ª–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫—É
      document.querySelector(`.tab-bar .tab:nth-child(${{ actions: 1, messages: 2, game: 3, profile: 4 }[tabName]})`).classList.add('active');
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
    function loadActions() {
      if (user.id) {
        fetch(`${API_URL}/api/user/actions?user_id=${user.id}`)
          .then(r => r.json())
          .then(data => {
            const container = document.getElementById('actions');
            container.innerHTML = '';
            if (!data || data.length === 0) {
              container.textContent = '–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π.';
              return;
            }
            data.forEach(item => {
              const div = document.createElement('div');
              div.className = 'action';
              const time = new Date(item.time).toLocaleString('ru-RU');
              div.textContent = `[${time}] ${item.action}`;
              container.appendChild(div);
            });
          });
      }
    }

    function loadMessages() {
      if (user.id) {
        fetch(`${API_URL}/api/user/messages?user_id=${user.id}`)
          .then(r => r.json())
          .then(data => {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            if (!data || data.length === 0) {
              container.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.';
              return;
            }
            data.forEach(msg => {
              const div = document.createElement('div');
              div.className = 'message message-user';
              const time = new Date(msg.time).toLocaleTimeString('ru-RU');
              div.textContent = `[${time}] ${msg.text}`;
              container.appendChild(div);
            });
          });
      }
    }

    function loadProfile() {
      if (user.id) {
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        fetch(`${API_URL}/api/stats`)
          .then(r => r.json())
          .then(data => {
            document.getElementById('user-count').textContent = data.users || 0;
            document.getElementById('action-count').textContent = data.actions || 0;
          });

        // –ü—Ä–æ—Ñ–∏–ª—å
        fetch(`${API_URL}/api/user/profile?user_id=${user.id}`)
          .then(r => r.json())
          .then(data => {
            const info = document.getElementById('profile-info');
            info.innerHTML = `
              <strong>–Æ–∑–µ—Ä–Ω–µ–π–º:</strong> ${data.username || '‚Äî'}<br>
              <strong>–ò–º—è:</strong> ${data.first_name || '‚Äî'}<br>
              <strong>–î–∞—Ç–∞:</strong> ${data.created_at?.split('T')[0] || '‚Äî'}
            `;
          });
      }
    }

    // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ---
    function sendMessage() {
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      if (!text || !user.id) return;

      fetch(`${API_URL}/api/user/message`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: user.id, text: text })
      })
      .then(r => r.json())
      .then(() => {
        input.value = '';
        loadMessages();
      });
    }

    // --- –ò–≥—Ä–∞ ---
    function makeGuess() {
      const guess = document.getElementById('guess').value;
      if (!guess) return;
      const result = document.getElementById('game-result');
      const secret = Math.floor(Math.random() * 10) + 1;
      if (guess == secret) {
        result.innerHTML = `<span style="color:green">üéâ –£–≥–∞–¥–∞–ª! –Ø –∑–∞–≥–∞–¥–∞–ª ${secret}</span>`;
      } else {
        result.innerHTML = `<span style="color:red">‚ùå –ù–µ —É–≥–∞–¥–∞–ª! –Ø –∑–∞–≥–∞–¥–∞–ª ${secret}</span>`;
      }
      setTimeout(() => result.innerHTML = '', 2000);
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ---
    loadActions();
    loadMessages();
    loadProfile();

    // –°—Ç–∞—Ä—Ç —Å –≤–∫–ª–∞–¥–∫–∏ "–î–µ–π—Å—Ç–≤–∏—è"
    switchTab('actions');
  </script>
</body>
</html>
